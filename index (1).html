<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fred Stock Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #1e293b; font-size: 13px; }
        
        /* Masquage des √©crans de s√©curit√© */
        #firstLaunchOverlay, #loginOverlay { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; flex-direction: column; }
        .login-box { background: white; padding: 2.5rem; border-radius: 1rem; color: #333; width: 300px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); }
        .login-box h2 { font-size: 1.2rem; margin-bottom: 1rem; color: var(--primary); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 1rem; box-sizing: border-box; }

        #mainApp { display: none; }
        .header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 100; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; border-bottom: 5px solid #ddd; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card span { display: block; font-size: 2rem; font-weight: 800; margin-top: 10px; }

        .forms-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .btn { border: none; padding: 14px; border-radius: 8px; color: white; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn:active { transform: scale(0.96); opacity: 0.8; }

        .grid-data { display: grid; grid-template-columns: 1fr 2.5fr; gap: 20px; }
        @media (max-width: 1000px) { .grid-data { grid-template-columns: 1fr; } }
        
        .table-wrapper { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .filter-header { padding: 15px; background: #f8fafc; border-bottom: 1px solid #eee; }
        .filter-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        
        .scroll-area { max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: left; }
        th { background: #f8fafc; font-size: 0.75rem; color: #64748b; text-transform: uppercase; position: sticky; top: 0; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .b-in { background: #dcfce7; color: #166534; }
        .b-out { background: #fef9c3; color: #854d0e; }
        .b-loss { background: #fee2e2; color: #991b1b; }
        .btn-del { background: none; border: none; cursor: pointer; color: var(--danger); font-size: 1.1rem; padding: 5px; }
        .btn-del:hover { background: #fee2e2; border-radius: 5px; }
    </style>
</head>
<body>

<div id="firstLaunchOverlay" style="display:none">
    <div class="login-box">
        <h2>Syst√®me Fred Stock</h2>
        <input type="password" id="actCode" placeholder="Code d'autorisation">
        <button class="btn" style="background:var(--accent)" onclick="verifyAct()">ACTIVER</button>
    </div>
</div>

<div id="loginOverlay" style="display:none">
    <div class="login-box">
        <h2>Acc√®s Restreint</h2>
        <input type="password" id="pin" placeholder="Cl√© d'acc√®s">
        <button class="btn" style="background:var(--primary)" onclick="verifyPin()">ENTRER</button>
    </div>
</div>

<div id="mainApp">
    <div class="header">
        <h2 style="margin:0">FRED <span style="color:var(--accent)">STOCK HUB</span></h2>
        <button onclick="exportFilteredPDF()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">üñ®Ô∏è RAPPORT PDF</button>
    </div>

    <div class="container">
        <div class="summary">
            <div class="card" style="border-color:var(--success)">ENTR√âES<span id="statIn" style="color:var(--success)">0</span></div>
            <div class="card" style="border-color:var(--warning)">SORTIES<span id="statOut" style="color:var(--warning)">0</span></div>
            <div class="card" style="border-color:var(--danger)">PERTES<span id="statLoss" style="color:var(--danger)">0</span></div>
            <div class="card" style="border-color:var(--accent)">EN STOCK<span id="statNet" style="color:var(--accent)">0</span></div>
        </div>

        <div class="forms-grid">
            <div class="box"><h3 style="color:var(--success)">üì• ENTR√âE</h3>
                <input type="text" id="pIn" list="prodList" placeholder="Article">
                <input type="number" id="qIn" placeholder="Quantit√©">
                <input type="text" id="rIn" placeholder="Remarque">
                <button class="btn" style="background:var(--success)" onclick="handle('ENTR√âE')">VALIDER</button>
            </div>
            <div class="box"><h3 style="color:var(--warning)">üì§ SORTIE</h3>
                <input type="text" id="pOut" list="prodList" placeholder="Article">
                <input type="number" id="qOut" placeholder="Quantit√©">
                <input type="text" id="rOut" placeholder="Remarque">
                <button class="btn" style="background:var(--warning)" onclick="handle('SORTIE')">VALIDER</button>
            </div>
            <div class="box"><h3 style="color:var(--danger)">‚ùå PERTE</h3>
                <input type="text" id="pLoss" list="prodList" placeholder="Article">
                <input type="number" id="qLoss" placeholder="Quantit√©">
                <input type="text" id="rLoss" placeholder="Remarque">
                <button class="btn" style="background:var(--danger)" onclick="handle('PERTE')">VALIDER</button>
            </div>
        </div>

        <div class="grid-data">
            <div class="table-wrapper">
                <div class="filter-header"><b>üì¶ STOCK</b></div>
                <div class="scroll-area"><table><thead><tr><th>Article</th><th>Qt√©</th></tr></thead><tbody id="stockTable"></tbody></table></div>
            </div>

            <div class="table-wrapper">
                <div class="filter-header">
                    <b>üìú HISTORIQUE</b>
                    <div class="filter-controls">
                        <input type="text" id="fProd" onkeyup="render()" placeholder="Rechercher...">
                        <input type="date" id="fDate" onchange="render()">
                        <select id="fType" onchange="render()">
                            <option value="">Tous les types</option>
                            <option value="ENTR√âE">Entr√©es</option>
                            <option value="SORTIE">Sorties</option>
                            <option value="PERTE">Pertes</option>
                        </select>
                    </div>
                </div>
                <div class="scroll-area">
                    <table>
                        <thead><tr><th>Date</th><th>Type</th><th>Produit</th><th>Qt√©</th><th>Note</th><th></th></tr></thead>
                        <tbody id="logTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<datalist id="prodList"></datalist>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBnexu5NU8c6mD6dM4Gh-fMxCI2A7fmyxo",
      authDomain: "fredstockstandard.firebaseapp.com",
      databaseURL: "https://fredstockstandard-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fredstockstandard",
      storageBucket: "fredstockstandard.firebasestorage.app",
      messagingSenderId: "348685198376",
      appId: "1:348685198376:web:b2077f9f543589dccc811d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let movements = [];

    // S√©curit√© avec masquage des codes
    function verifyAct() { if(document.getElementById('actCode').value === "inventory1990") { localStorage.setItem('fred_v2026_secure', 'OK'); location.reload(); } }
    function verifyPin() { if(document.getElementById('pin').value === "123456abc") { document.getElementById('loginOverlay').style.display='none'; document.getElementById('mainApp').style.display='block'; sync(); } }
    
    window.onload = () => {
        if(localStorage.getItem('fred_v2026_secure') !== 'OK') document.getElementById('firstLaunchOverlay').style.display='flex';
        else document.getElementById('loginOverlay').style.display='flex';
    };

    function sync() {
        db.ref('movements').on('value', snap => {
            const data = snap.val();
            movements = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})).reverse() : [];
            render();
        });
    }

    function handle(type) {
        let suf = type==='ENTR√âE'?'In':(type==='SORTIE'?'Out':'Loss');
        let p = document.getElementById('p'+suf).value.toUpperCase().trim();
        let q = parseFloat(document.getElementById('q'+suf).value) || 0;
        let r = document.getElementById('r'+suf).value || "-";

        if(!p || q <= 0) return;

        db.ref('movements').push({
            type, p, q, r,
            day: new Date().toLocaleDateString('fr-CA'),
            full: new Date().toLocaleString('fr-FR', {dateStyle:'short', timeStyle:'short'})
        }).then(() => {
            document.getElementById('p'+suf).value = ''; document.getElementById('q'+suf).value = ''; document.getElementById('r'+suf).value = '';
        });
    }

    function deleteItem(key) {
        if(confirm("Confirmer la suppression ?")) {
            db.ref('movements/' + key).remove();
        }
    }

    function render() {
        const fP = document.getElementById('fProd').value.toUpperCase();
        const fD = document.getElementById('fDate').value;
        const fT = document.getElementById('fType').value;
        const sBody = document.getElementById('stockTable');
        const lBody = document.getElementById('logTable');
        const dList = document.getElementById('prodList');
        
        sBody.innerHTML = ""; lBody.innerHTML = ""; dList.innerHTML = "";
        let inv = {}; let st = { i:0, o:0, l:0 };

        movements.forEach(m => {
            if(!inv[m.p]) inv[m.p] = { i:0, o:0, l:0 };
            if(m.type === 'ENTR√âE') { inv[m.p].i += m.q; st.i += m.q; }
            else if(m.type === 'SORTIE') { inv[m.p].o += m.q; st.o += m.q; }
            else { inv[m.p].l += m.q; st.l += m.q; }

            if((!fP || m.p.includes(fP)) && (!fD || m.day === fD) && (!fT || m.type === fT)) {
                let b = m.type==='ENTR√âE'?'b-in':(m.type==='SORTIE'?'b-out':'b-loss');
                lBody.innerHTML += `<tr>
                    <td><small>${m.full}</small></td>
                    <td><span class="badge ${b}">${m.type}</span></td>
                    <td><b>${m.p}</b></td>
                    <td>${m.q}</td>
                    <td>${m.r}</td>
                    <td><button class="btn-del" onclick="deleteItem('${m.firebaseKey}')">üóëÔ∏è</button></td>
                </tr>`;
            }
        });

        Object.keys(inv).sort().forEach(p => {
            dList.innerHTML += `<option value="${p}">`;
            let total = inv[p].i - inv[p].o - inv[p].l;
            sBody.innerHTML += `<tr><td><b>${p}</b></td><td><b>${total}</b></td></tr>`;
        });

        document.getElementById('statIn').innerText = st.i;
        document.getElementById('statOut').innerText = st.o;
        document.getElementById('statLoss').innerText = st.l;
        document.getElementById('statNet').innerText = (st.i - st.o - st.l);
    }

    function exportFilteredPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("RAPPORT DE STOCK", 14, 15);
        const rows = [];
        document.querySelectorAll("#logTable tr").forEach(tr => {
            const cols = tr.querySelectorAll("td");
            if(cols.length > 0) rows.push([cols[0].innerText, cols[1].innerText, cols[2].innerText, cols[3].innerText, cols[4].innerText]);
        });
        doc.autoTable({ head: [['Date', 'Type', 'Produit', 'Qt√©', 'Note']], body: rows, startY: 25 });
        doc.save("Inventaire.pdf");
    }
</script>
</body>
</html>